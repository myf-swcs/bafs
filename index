<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿåœ¨ç·šè™›æ“¬æº«ç¿’å®¤ - é›²ç«¯å…±å­¸å¹³å°</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f6;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #auth-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #main-app {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        .room-list {
            flex: 1;
            overflow-y: auto;
        }
        .room-item {
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f8f9fa;
        }
        .room-item:hover {
            background-color: #f0f7ff;
        }
        .room-item.active {
            background-color: #e7f1ff;
            border-left: 4px solid var(--primary-color);
        }

        /* Content Area Styles */
        .content-area {
            flex: 1;
            display: flex;
            background: #fff;
        }
        .chat-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }
        .info-section {
            flex: 1;
            background: #fafafa;
            overflow-y: auto;
            padding: 20px;
        }

        /* Chat Styles */
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fdfdfd;
        }
        .msg {
            margin-bottom: 10px;
            max-width: 85%;
        }
        .msg-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            display: inline-block;
            background: #e9ecef;
        }
        .msg-me {
            margin-left: auto;
            text-align: right;
        }
        .msg-me .msg-bubble {
            background: var(--primary-color);
            color: white;
        }
        .msg-info {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 2px;
        }

        /* Timer Card */
        .timer-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            text-align: center;
        }
        .timer-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        /* Utility */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #aaa;
        }

        @media (max-width: 768px) {
            .sidebar { width: 100px; }
            .sidebar span { display: none; }
            .info-section { display: none; }
        }

        /* Google Button Style */
        .btn-google {
            background-color: white;
            color: #757575;
            border: 1px solid #dadce0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 500;
        }
        .btn-google:hover {
            background-color: #f8f9fa;
            border-color: #d2d2d2;
        }
    </style>
</head>
<body>

<!-- 1. ç™»å…¥ä»‹é¢ -->
<div id="auth-screen">
    <div class="card shadow-sm" style="width: 350px;">
        <div class="card-body text-center p-4">
            <h3 class="mb-4 fw-bold">è™›æ“¬æº«ç¿’å®¤</h3>
            <p class="text-muted mb-4">ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥ä»¥è¨˜éŒ„ä½ çš„æº«ç¿’æ™‚æ•¸</p>
            <button id="btn-login-google" class="btn btn-google w-100 py-2">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                ä½¿ç”¨ Google ç™»å…¥
            </button>
        </div>
    </div>
</div>

<!-- 2. ä¸»ä»‹é¢ -->
<div id="main-app">
    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="navbar px-3">
        <span class="navbar-brand fw-bold text-primary">ğŸ“š StudyRoom Online</span>
        <div class="d-flex align-items-center">
            <span id="user-display-name" class="me-3 text-muted small"></span>
            <button id="btn-logout" class="btn btn-outline-danger btn-sm">é€€å‡º</button>
        </div>
    </nav>

    <div class="main-container">
        <!-- å·¦å´ï¼šæˆ¿é–“åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold">æº«ç¿’æˆ¿é–“</h6>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRoomModal">+</button>
            </div>
            <div id="room-list" class="room-list">
                <!-- æˆ¿é–“æ¸…å–®è¼‰å…¥è™• -->
            </div>
        </div>

        <!-- å³å´ï¼šä¸»è¦å…§å®¹ -->
        <div class="content-area" id="room-content">
            <!-- æœªé¸å–æˆ¿é–“æ™‚é¡¯ç¤º -->
            <div id="no-room-selected" class="empty-state w-100">
                <img src="https://cdn-icons-png.flaticon.com/512/2436/2436702.png" width="100" class="mb-3" style="opacity: 0.2;">
                <h5>è«‹é¸æ“‡ä¸€å€‹æˆ¿é–“é–‹å§‹æº«ç¿’</h5>
            </div>

            <!-- é¸å–æˆ¿é–“å¾Œé¡¯ç¤º -->
            <div id="active-room-ui" class="w-100 h-100 d-none" style="display: flex;">
                <div class="chat-section">
                    <div class="p-3 border-bottom bg-light">
                        <h6 id="current-room-name" class="mb-0 fw-bold text-truncate">æˆ¿é–“åç¨±</h6>
                    </div>
                    <div id="chat-messages"></div>
                    <div class="p-3 border-top">
                        <form id="chat-form" class="d-flex gap-2">
                            <input type="text" id="chat-input" class="form-control" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
                            <button type="submit" class="btn btn-primary px-4">ç™¼é€</button>
                        </form>
                    </div>
                </div>

                <div class="info-section">
                    <!-- è¨ˆæ™‚å™¨ -->
                    <div class="timer-card">
                        <h6 class="text-muted mb-0">æˆ‘çš„æº«ç¿’è¨ˆæ™‚</h6>
                        <div class="timer-display" id="timer-text">00:00:00</div>
                        <div class="d-flex justify-content-center gap-2">
                            <button id="btn-timer-start" class="btn btn-success btn-sm">é–‹å§‹</button>
                            <button id="btn-timer-pause" class="btn btn-warning btn-sm d-none">æš«åœ</button>
                            <button id="btn-timer-reset" class="btn btn-outline-secondary btn-sm">é‡ç½®</button>
                        </div>
                        <div class="mt-2 small text-muted">ç´¯è¨ˆï¼š<span id="total-study-time">0</span> åˆ†é˜</div>
                    </div>

                    <!-- åœ¨ç·šåå–® -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">ç•¶å‰åœ¨ç·š (<span id="online-count">0</span>)</h6>
                        <div id="online-users" class="list-group list-group-flush small shadow-sm rounded">
                            <!-- åœ¨ç·šä½¿ç”¨è€…æ¸…å–® -->
                        </div>
                    </div>

                    <!-- æ’è¡Œæ¦œ -->
                    <div>
                        <h6 class="fw-bold mb-3">æœ¬å®¤æº«ç¿’æ’è¡Œ (Top 3)</h6>
                        <div id="leaderboard" class="list-group list-group-flush small shadow-sm rounded">
                            <!-- æ’è¡Œæ¦œæ¸…å–® -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å»ºç«‹æˆ¿é–“ Modal -->
<div class="modal fade" id="createRoomModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å»ºç«‹æ–°æº«ç¿’å®¤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="new-room-name" class="form-control" placeholder="æˆ¿é–“åç¨± (ä¾‹å¦‚: æ•¸å­¸å°ˆæ³¨å€)">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" id="btn-create-room" class="btn btn-primary">ç¢ºèªå»ºç«‹</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, serverTimestamp, onDisconnect, remove, update, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- Firebase é…ç½®å·²æ›´æ–° ---
    const firebaseConfig = {
        apiKey: "AIzaSyDBrU-Oy70pCPXTDsis1gC-TAge0RqXrmY",
        authDomain: "timer-9545c.firebaseapp.com",
        databaseURL: "https://timer-9545c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "timer-9545c",
        storageBucket: "timer-9545c.firebasestorage.app",
        messagingSenderId: "272069871280",
        appId: "1:272069871280:web:c8e8e1d4d06a8542f51d75"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let currentNickname = "å­¸ç”Ÿ";
    let activeRoomId = null;
    let studyInterval = null;
    let sessionSeconds = 0;
    let currentTotalMinutes = 0;

    // DOM å…ƒç´ 
    const authScreen = document.getElementById('auth-screen');
    const mainApp = document.getElementById('main-app');
    const roomListContainer = document.getElementById('room-list');
    const chatMessages = document.getElementById('chat-messages');
    const onlineUsersList = document.getElementById('online-users');
    const leaderboardList = document.getElementById('leaderboard');

    // --- 1. èº«ä»½é©—è­‰åŠŸèƒ½ ---

    // Google ç™»å…¥
    document.getElementById('btn-login-google').addEventListener('click', async () => {
        try {
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Login Error:", error);
            alert("Google ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase å·²å•Ÿç”¨ Google ç™»å…¥æ–¹æ³•ã€‚");
        }
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            currentNickname = user.displayName || "å­¸ç”Ÿ";
            authScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            document.getElementById('user-display-name').innerText = `ä½ å¥½, ${currentNickname}`;
            initRoomList();
        } else {
            authScreen.style.display = 'flex';
            mainApp.style.display = 'none';
            cleanupRoomSession();
        }
    });

    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // --- 2. æˆ¿é–“ç³»çµ±åŠŸèƒ½ ---

    function initRoomList() {
        const roomsRef = ref(db, 'rooms');
        onValue(roomsRef, (snapshot) => {
            roomListContainer.innerHTML = '';
            const rooms = snapshot.val();
            if (!rooms) return;

            Object.keys(rooms).forEach(roomId => {
                const room = rooms[roomId];
                const div = document.createElement('div');
                div.className = `room-item p-3 ${activeRoomId === roomId ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="fw-bold">${room.name}</div>
                    <div class="small text-muted">å»ºç«‹è€…: ${room.createdBy}</div>
                `;
                div.onclick = () => joinRoom(roomId, room.name);
                roomListContainer.appendChild(div);
            });
        });
    }

    document.getElementById('btn-create-room').addEventListener('click', async () => {
        const roomName = document.getElementById('new-room-name').value.trim();
        if (!roomName) return alert("è«‹è¼¸å…¥æˆ¿é–“åç¨±");

        const roomsRef = ref(db, 'rooms');
        const newRoomRef = push(roomsRef);
        await set(newRoomRef, {
            name: roomName,
            createdBy: currentNickname,
            createdAt: serverTimestamp()
        });

        const modalElement = document.getElementById('createRoomModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        document.getElementById('new-room-name').value = '';
        joinRoom(newRoomRef.key, roomName);
    });

    async function joinRoom(roomId, roomName) {
        if (activeRoomId === roomId) return;
        cleanupRoomSession();

        activeRoomId = roomId;
        document.getElementById('active-room-ui').classList.remove('d-none');
        document.getElementById('no-room-selected').classList.add('d-none');
        document.getElementById('current-room-name').innerText = roomName;
        
        document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
        
        const myStatusRef = ref(db, `rooms/${roomId}/onlineUsers/${currentUser.uid}`);
        set(myStatusRef, { name: currentNickname, lastSeen: serverTimestamp() });
        onDisconnect(myStatusRef).remove();

        const myTimeRef = ref(db, `rooms/${roomId}/studyTimes/${currentUser.uid}`);
        onValue(myTimeRef, (snap) => {
            const data = snap.val();
            currentTotalMinutes = data ? data.total : 0;
            document.getElementById('total-study-time').innerText = currentTotalMinutes;
        }, { onlyOnce: true });

        startRoomListeners(roomId);
    }

    function cleanupRoomSession() {
        if (activeRoomId && currentUser) {
            remove(ref(db, `rooms/${activeRoomId}/onlineUsers/${currentUser.uid}`));
        }
        stopTimer();
        chatMessages.innerHTML = '';
        activeRoomId = null;
    }

    // --- 3. æˆ¿é–“å…§åŠŸèƒ½å¯¦ä½œ ---

    function startRoomListeners(roomId) {
        const chatRef = query(ref(db, `rooms/${roomId}/chat`), limitToLast(50));
        onValue(chatRef, (snapshot) => {
            chatMessages.innerHTML = '';
            snapshot.forEach((child) => {
                const msg = child.val();
                appendChatMessage(msg);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        const onlineRef = ref(db, `rooms/${roomId}/onlineUsers`);
        onValue(onlineRef, (snapshot) => {
            onlineUsersList.innerHTML = '';
            const users = snapshot.val();
            let count = 0;
            if (users) {
                Object.values(users).forEach(u => {
                    count++;
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex align-items-center bg-transparent border-0 py-1';
                    item.innerHTML = `<span class="text-success me-2">â—</span> ${u.name}`;
                    onlineUsersList.appendChild(item);
                });
            }
            document.getElementById('online-count').innerText = count;
        });

        const timesRef = ref(db, `rooms/${roomId}/studyTimes`);
        onValue(timesRef, (snapshot) => {
            const times = [];
            snapshot.forEach(child => {
                const data = child.val();
                times.push({ uid: child.key, total: data.total });
            });
            times.sort((a, b) => b.total - a.total);
            const top3 = times.slice(0, 3);

            leaderboardList.innerHTML = '';
            top3.forEach((t, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center bg-transparent border-0';
                item.innerHTML = `<span>#${index+1} å­¸ç”Ÿ(${t.uid.substring(0,4)})</span> <span class="badge bg-primary rounded-pill">${t.total} åˆ†é˜</span>`;
                leaderboardList.appendChild(item);
            });
            if (top3.length === 0) {
                leaderboardList.innerHTML = '<div class="text-muted text-center p-2 small">å°šç„¡æ•¸æ“š</div>';
            }
        });
    }

    document.getElementById('chat-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = document.getElementById('chat-input').value.trim();
        if (!text || !activeRoomId) return;

        const chatRef = ref(db, `rooms/${activeRoomId}/chat`);
        push(chatRef, {
            user: currentNickname,
            uid: currentUser.uid,
            text: text,
            timestamp: serverTimestamp()
        });
        document.getElementById('chat-input').value = '';
    });

    function appendChatMessage(msg) {
        const isMe = msg.uid === currentUser.uid;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-me' : ''}`;
        div.innerHTML = `
            <div class="msg-info">${msg.user}</div>
            <div class="msg-bubble">${msg.text}</div>
        `;
        chatMessages.appendChild(div);
    }

    // --- 4. è¨ˆæ™‚å™¨é‚è¼¯ ---

    const timerText = document.getElementById('timer-text');
    const btnStart = document.getElementById('btn-timer-start');
    const btnPause = document.getElementById('btn-timer-pause');
    const btnReset = document.getElementById('btn-timer-reset');

    btnStart.onclick = () => {
        if (studyInterval) return;
        btnStart.classList.add('d-none');
        btnPause.classList.remove('d-none');
        studyInterval = setInterval(() => {
            sessionSeconds++;
            updateTimerDisplay();
            
            if (sessionSeconds % 60 === 0) {
                currentTotalMinutes++;
                updateFirebaseStudyTime();
            }
        }, 1000);
    };

    btnPause.onclick = stopTimer;

    btnReset.onclick = () => {
        stopTimer();
        sessionSeconds = 0;
        updateTimerDisplay();
    };

    function stopTimer() {
        clearInterval(studyInterval);
        studyInterval = null;
        btnStart.classList.remove('d-none');
        btnPause.classList.add('d-none');
    }

    function updateTimerDisplay() {
        const hrs = Math.floor(sessionSeconds / 3600).toString().padStart(2, '0');
        const mins = Math.floor((sessionSeconds % 3600) / 60).toString().padStart(2, '0');
        const secs = (sessionSeconds % 60).toString().padStart(2, '0');
        timerText.innerText = `${hrs}:${mins}:${secs}`;
    }

    async function updateFirebaseStudyTime() {
        if (!activeRoomId || !currentUser) return;
        const timeRef = ref(db, `rooms/${activeRoomId}/studyTimes/${currentUser.uid}`);
        await update(timeRef, { total: currentTotalMinutes });
        document.getElementById('total-study-time').innerText = currentTotalMinutes;
    }

</script>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
